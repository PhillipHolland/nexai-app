{% extends "base.html" %}

{% block title %}Digital Evidence Analysis - LexAI{% endblock %}

{% block extra_head %}
    <style>
        /* Evidence page uses base layout - no need for custom navigation */
        .evidence-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background-color: #F7EDDA; /* Match landing page background */
            min-height: calc(100vh - 4rem); /* Account for navbar height */
        }
        
        .evidence-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .evidence-header h1 {
            color: #2E4B3C;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .evidence-header p {
            color: #6b7280;
            font-size: 1.2rem;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .evidence-tools {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        .evidence-tool {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .evidence-tool:hover {
            border-color: #FFA74F;
            transform: translateY(-2px);
            box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .evidence-tool.primary {
            border-color: #FFA74F;
            background: linear-gradient(135deg, #FFA74F 0%, #F0531C 100%);
            color: white;
        }
        
        .evidence-tool.primary h3,
        .evidence-tool.primary p {
            color: white;
        }
        
        .tool-icon {
            width: 3rem;
            height: 3rem;
            background: #2E4B3C;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            color: white;
        }
        
        .evidence-tool.primary .tool-icon {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .evidence-tool h3 {
            color: #2E4B3C;
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }
        
        .evidence-tool p {
            color: #6b7280;
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        
        .tool-features {
            list-style: none;
            padding: 0;
        }
        
        .tool-features li {
            padding: 0.25rem 0;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .tool-features li:before {
            content: "‚úì ";
            color: #FFA74F;
            font-weight: bold;
        }
        
        .evidence-tool.primary .tool-features li:before {
            color: white;
        }
        
        .upload-area {
            background: #F7EDDA;
            border: 2px dashed #FFA74F;
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            margin: 2rem 0;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            background: #f0e68c;
            border-color: #F0531C;
        }
        
        .upload-area.dragover {
            background: #FFA74F;
            color: white;
        }
        
        .upload-icon {
            width: 4rem;
            height: 4rem;
            background: #FFA74F;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: white;
            font-size: 1.5rem;
        }
        
        .btn-evidence {
            background: #2E4B3C;
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-evidence:hover {
            background: #09332C;
            transform: translateY(-1px);
        }
        
        .btn-evidence.primary {
            background: #FFA74F;
            color: #2E4B3C;
        }
        
        .btn-evidence.primary:hover {
            background: #F0531C;
        }
    </style>
{% endblock %}

{% block content %}
    <main class="evidence-container">
        <div class="evidence-header">
            <h1>üîç Digital Evidence Analysis Suite</h1>
            <p>Advanced AI-powered tools for authenticating, analyzing, and validating digital evidence for legal proceedings</p>
        </div>

        <!-- Quick Upload Section -->
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÑ</div>
            <h3>Drag & Drop Documents or Text</h3>
            <p>Upload documents, images, or paste text for instant analysis</p>
            <input type="file" id="fileInput" multiple accept=".pdf,.docx,.txt,.png,.jpg,.jpeg" style="display: none;">
            <button class="btn-evidence primary" onclick="document.getElementById('fileInput').click()">
                Choose Files
            </button>
        </div>

        <div class="evidence-tools">
            <!-- AI Content Detection -->
            <div class="evidence-tool primary" onclick="showAIDetector()">
                <div class="tool-icon">ü§ñ</div>
                <h3>AI Content Detection</h3>
                <p>Detect artificially generated text, identify deepfakes, and analyze writing patterns for authenticity</p>
                <ul class="tool-features">
                    <li>GPT/AI-generated text detection</li>
                    <li>Writing style analysis</li>
                    <li>Authenticity scoring</li>
                    <li>Pattern recognition</li>
                </ul>
            </div>

            <!-- Document Authentication -->
            <div class="evidence-tool" onclick="showDocAuth()">
                <div class="tool-icon">üîê</div>
                <h3>Document Authentication</h3>
                <p>Verify document integrity, validate digital signatures, and ensure chain of custody</p>
                <ul class="tool-features">
                    <li>Hash verification</li>
                    <li>Metadata analysis</li>
                    <li>Digital signature validation</li>
                    <li>Timestamp verification</li>
                </ul>
            </div>

            <!-- Legal Admissibility Checker -->
            <div class="evidence-tool" onclick="showAdmissibility()">
                <div class="tool-icon">‚öñÔ∏è</div>
                <h3>Legal Admissibility</h3>
                <p>Analyze evidence for hearsay issues, authentication requirements, and court readiness</p>
                <ul class="tool-features">
                    <li>Hearsay rule analysis</li>
                    <li>Authentication checklist</li>
                    <li>Federal Rules compliance</li>
                    <li>Court-ready reports</li>
                </ul>
            </div>

            <!-- Evidence Reports -->
            <div class="evidence-tool" onclick="showReports()">
                <div class="tool-icon">üìä</div>
                <h3>Evidence Reports</h3>
                <p>Generate comprehensive reports for court presentation and expert testimony</p>
                <ul class="tool-features">
                    <li>Professional formatting</li>
                    <li>Expert witness support</li>
                    <li>Chain of custody tracking</li>
                    <li>Technical documentation</li>
                </ul>
            </div>
        </div>

        <!-- AI Content Detection Interface -->
        <div id="aiDetectionInterface" style="display: none;">
            <div style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 2rem;">
                <h3>ü§ñ AI Content Detection</h3>
                <p>Paste or type text content to analyze for AI-generated patterns</p>
                
                <div style="margin: 1rem 0;">
                    <textarea id="textInput" placeholder="Paste text content here for analysis..." 
                              style="width: 100%; height: 200px; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
                </div>
                
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button class="btn-evidence primary" onclick="analyzeText()">
                        üîç Analyze Text
                    </button>
                    <button class="btn-evidence" onclick="clearAnalysis()">
                        Clear
                    </button>
                    <span id="charCount" style="color: #6b7280; font-size: 0.9rem;">0 characters</span>
                </div>
            </div>
        </div>

        <!-- Document Authentication Interface -->
        <div id="docAuthInterface" style="display: none;">
            <div style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 2rem;">
                <h3>üîê Document Authentication</h3>
                <p>Upload documents for integrity verification, hash analysis, and metadata extraction</p>
                
                <div class="upload-area" id="docUploadArea" style="margin: 1rem 0;">
                    <div class="upload-icon">üìÑ</div>
                    <h4>Drop Document Here or Click to Upload</h4>
                    <p>Supports: PDF, Word (.docx/.doc), Text, Images (.jpg/.png)</p>
                    <input type="file" id="docFileInput" accept=".pdf,.docx,.doc,.txt,.png,.jpg,.jpeg" style="display: none;">
                    <button class="btn-evidence primary" onclick="document.getElementById('docFileInput').click()">
                        üìÅ Choose Document
                    </button>
                </div>
                
                <div id="docUploadStatus" style="display: none; margin: 1rem 0; padding: 1rem; background: #f9fafb; border-radius: 8px;">
                    <p id="docStatusText">Ready to analyze...</p>
                </div>
            </div>
        </div>

        <!-- Legal Admissibility Checker Interface -->
        <div id="admissibilityInterface" style="display: none;">
            <div style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 2rem;">
                <h3>‚öñÔ∏è Legal Admissibility Checker</h3>
                <p>Analyze evidence for Federal Rules of Evidence compliance, hearsay issues, and court admissibility</p>
                
                <div style="margin: 1.5rem 0;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #2E4B3C;">Evidence Type:</label>
                    <select id="evidenceType" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit;">
                        <option value="document">Document</option>
                        <option value="photograph">Photograph</option>
                        <option value="recording">Audio/Video Recording</option>
                        <option value="digital">Digital Evidence</option>
                        <option value="testimony">Witness Testimony</option>
                        <option value="physical">Physical Evidence</option>
                        <option value="expert">Expert Opinion</option>
                    </select>
                </div>
                
                <div style="margin: 1.5rem 0;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #2E4B3C;">Evidence Description:</label>
                    <textarea id="evidenceDescription" placeholder="Describe the evidence, how it was obtained, and what it tends to prove. Include any relevant circumstances..."
                              style="width: 100%; height: 120px; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
                </div>
                
                <div style="margin: 1.5rem 0;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #2E4B3C;">Source Information (Optional):</label>
                    <textarea id="sourceInfo" placeholder="Provide information about the source, custodian, or witness who can authenticate this evidence..."
                              style="width: 100%; height: 80px; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
                </div>
                
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button class="btn-evidence primary" onclick="analyzeAdmissibility()">
                        ‚öñÔ∏è Analyze Admissibility
                    </button>
                    <button class="btn-evidence" onclick="clearAdmissibility()">
                        Clear
                    </button>
                    <span id="descriptionCount" style="color: #6b7280; font-size: 0.9rem;">0 characters</span>
                </div>
            </div>
        </div>

        <!-- Report Generator Interface -->
        <div id="reportInterface" style="display: none;">
            <div style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 2rem;">
                <h3>üìä Court-Ready Report Generator</h3>
                <p>Generate professional legal reports from your analysis results for court presentation and expert testimony</p>
                
                <div style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; margin: 1rem 0;">
                    <h4 style="margin: 0 0 1rem 0; color: #2E4B3C;">Available Analysis Results:</h4>
                    <div id="availableAnalysis" style="color: #6b7280;">
                        No analysis results available yet. Please run an analysis first.
                    </div>
                </div>
                
                <div style="margin: 1.5rem 0;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #2E4B3C;">Case Information:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <input type="text" id="caseName" placeholder="Case Name" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                        <input type="text" id="caseNumber" placeholder="Case Number" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <input type="text" id="courtName" placeholder="Court Name" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                        <input type="text" id="attorneyName" placeholder="Attorney Name" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                    </div>
                </div>
                
                <div style="margin: 1.5rem 0;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #2E4B3C;">Report Type:</label>
                    <select id="reportType" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                        <option value="comprehensive">Comprehensive Analysis Report</option>
                        <option value="summary">Executive Summary Report</option>
                        <option value="technical">Technical Analysis Report</option>
                        <option value="legal">Legal Admissibility Report</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button class="btn-evidence primary" onclick="generateReport()" id="generateBtn" disabled>
                        üìÑ Generate Report
                    </button>
                    <button class="btn-evidence" onclick="clearReportForm()">
                        Clear Form
                    </button>
                    <span style="color: #6b7280; font-size: 0.9rem;">Professional court-ready formatting</span>
                </div>
            </div>
        </div>

        <!-- Analysis Results Area -->
        <div id="analysisResults" style="display: none;">
            <div style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                <h3>üìä Analysis Results</h3>
                <div id="resultsContent"></div>
                
                <!-- Generate Report Button for Results -->
                <div id="generateReportFromResults" style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; display: none;">
                    <button class="btn-evidence primary" onclick="showReportGenerator()">
                        üìÑ Generate Court Report
                    </button>
                    <span style="margin-left: 1rem; color: #6b7280; font-size: 0.9rem;">Create professional report from this analysis</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });
        
        function handleFiles(files) {
            console.log('Files uploaded:', files);
            // TODO: Implement file processing
            showAnalysisResults('Files uploaded successfully. Analysis in progress...');
        }
        
        // Character counter for text input
        const textInput = document.getElementById('textInput');
        const charCount = document.getElementById('charCount');
        
        if (textInput && charCount) {
            textInput.addEventListener('input', function() {
                const count = this.value.length;
                charCount.textContent = `${count} characters`;
                charCount.style.color = count < 10 ? '#F0531C' : '#6b7280';
            });
        }
        
        // Document authentication handling
        const docFileInput = document.getElementById('docFileInput');
        const docUploadArea = document.getElementById('docUploadArea');
        
        if (docFileInput && docUploadArea) {
            docUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                docUploadArea.classList.add('dragover');
            });
            
            docUploadArea.addEventListener('dragleave', () => {
                docUploadArea.classList.remove('dragover');
            });
            
            docUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                docUploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    analyzeDocument(files[0]);
                }
            });
            
            docFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    analyzeDocument(e.target.files[0]);
                }
            });
        }
        
        function analyzeDocument(file) {
            // Show upload status
            const statusDiv = document.getElementById('docUploadStatus');
            const statusText = document.getElementById('docStatusText');
            statusDiv.style.display = 'block';
            statusText.textContent = `Analyzing ${file.name}...`;
            
            // Create FormData for file upload
            const formData = new FormData();
            formData.append('file', file);
            
            // Make API call
            fetch('/api/evidence/doc-auth', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayDocumentResults(data.authentication, data.filename);
                } else {
                    showAnalysisResults('‚ùå Document analysis failed: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Document analysis error:', error);
                showAnalysisResults('‚ùå Network error occurred during document analysis.');
            });
        }
        
        function displayDocumentResults(auth, filename) {
            // Store results for report generation
            storedAnalysisResults = auth;
            analysisType = 'Document Authentication Analysis';
            
            const resultsHtml = `
                <div style="border-left: 4px solid ${auth.color}; padding-left: 1rem; margin-bottom: 2rem;">
                    <h4 style="color: ${auth.color}; margin-bottom: 0.5rem;">
                        ${auth.assessment}
                    </h4>
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <div style="background: ${auth.color}; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold;">
                            ${auth.integrity_score}% Integrity
                        </div>
                        <div style="background: #f3f4f6; padding: 0.5rem 1rem; border-radius: 20px;">
                            Risk: ${auth.risk_level}
                        </div>
                        <div style="background: #f3f4f6; padding: 0.5rem 1rem; border-radius: 20px; font-family: monospace;">
                            ${auth.file_info.size_readable}
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div>
                        <h5>üìÑ File Information</h5>
                        <ul style="list-style: none; padding: 0; font-size: 0.9rem;">
                            <li><strong>Filename:</strong> ${auth.file_info.filename}</li>
                            <li><strong>Type:</strong> ${auth.file_info.detected_type}</li>
                            <li><strong>Extension:</strong> ${auth.file_info.extension}</li>
                            <li><strong>Size:</strong> ${auth.file_info.size_readable}</li>
                        </ul>
                    </div>
                    <div>
                        <h5>üîê Hash Values</h5>
                        <div style="font-family: monospace; font-size: 0.8rem; background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <p><strong>MD5:</strong><br>${auth.hashes.md5}</p>
                            <p><strong>SHA256:</strong><br>${auth.hashes.sha256}</p>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div>
                        <h5>üìã Document Metadata</h5>
                        <ul style="list-style: none; padding: 0; font-size: 0.9rem;">
                            <li><strong>Creator:</strong> ${auth.metadata.creator}</li>
                            <li><strong>Software:</strong> ${auth.metadata.software}</li>
                            <li><strong>Created:</strong> ${auth.metadata.creation_date}</li>
                            <li><strong>Modified:</strong> ${auth.metadata.modification_date}</li>
                        </ul>
                    </div>
                    <div>
                        <h5>üõ°Ô∏è Security Analysis</h5>
                        ${auth.security_analysis.safe ? 
                            '<p style="color: #2E4B3C;">‚úÖ No security issues detected</p>' :
                            '<div><p style="color: #F0531C;">‚ö†Ô∏è Security Issues:</p><ul>' + 
                            auth.security_analysis.security_issues.map(issue => `<li>‚Ä¢ ${issue}</li>`).join('') + 
                            '</ul></div>'
                        }
                        ${auth.security_analysis.warnings.length > 0 ?
                            '<div><p><strong>Warnings:</strong></p><ul>' +
                            auth.security_analysis.warnings.map(warning => `<li>‚Ä¢ ${warning}</li>`).join('') +
                            '</ul></div>' : ''
                        }
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h5>üìã Chain of Custody</h5>
                    <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; font-size: 0.9rem;">
                        <p><strong>Timestamp:</strong> ${auth.chain_of_custody.timestamp}</p>
                        <p><strong>Action:</strong> ${auth.chain_of_custody.action}</p>
                        <p><strong>Officer:</strong> ${auth.chain_of_custody.officer}</p>
                        <p><strong>Hash:</strong> <code>${auth.chain_of_custody.hash}</code></p>
                    </div>
                </div>
                
                <div>
                    <h5>üí° Legal Recommendations</h5>
                    <ul>
                        ${auth.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
                
                <div style="margin-top: 2rem; padding: 1rem; background: #f9fafb; border-radius: 8px;">
                    <h6>‚öñÔ∏è Court Considerations</h6>
                    <p style="margin: 0; font-size: 0.9rem; color: #6b7280;">
                        Document authentication analysis provides technical evidence of integrity. Chain of custody 
                        documentation and expert testimony may be required for court admissibility. Hash values 
                        can be used to verify document integrity throughout legal proceedings.
                    </p>
                </div>
            `;
            
            showAnalysisResults(resultsHtml);
        }
        
        function showAIDetector() {
            // Hide other interfaces
            hideAllInterfaces();
            // Show AI detection interface
            document.getElementById('aiDetectionInterface').style.display = 'block';
            document.getElementById('aiDetectionInterface').scrollIntoView({ behavior: 'smooth' });
        }
        
        function showDocAuth() {
            hideAllInterfaces();
            document.getElementById('docAuthInterface').style.display = 'block';
            document.getElementById('docAuthInterface').scrollIntoView({ behavior: 'smooth' });
        }
        
        function showAdmissibility() {
            hideAllInterfaces();
            document.getElementById('admissibilityInterface').style.display = 'block';
            document.getElementById('admissibilityInterface').scrollIntoView({ behavior: 'smooth' });
        }
        
        function showReports() {
            hideAllInterfaces();
            document.getElementById('reportInterface').style.display = 'block';
            document.getElementById('reportInterface').scrollIntoView({ behavior: 'smooth' });
            updateAvailableAnalysis();
        }
        
        function hideAllInterfaces() {
            document.getElementById('aiDetectionInterface').style.display = 'none';
            document.getElementById('docAuthInterface').style.display = 'none';
            document.getElementById('admissibilityInterface').style.display = 'none';
            document.getElementById('reportInterface').style.display = 'none';
            document.getElementById('analysisResults').style.display = 'none';
        }
        
        function clearAnalysis() {
            document.getElementById('textInput').value = '';
            document.getElementById('charCount').textContent = '0 characters';
            document.getElementById('analysisResults').style.display = 'none';
        }
        
        function analyzeText() {
            const text = document.getElementById('textInput').value.trim();
            
            if (text.length < 10) {
                alert('Please enter at least 10 characters for analysis.');
                return;
            }
            
            // Show loading
            showAnalysisResults('üîÑ Analyzing text for AI-generated content patterns...');
            
            // Make API call
            fetch('/api/evidence/ai-detect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ text: text })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayAnalysisResults(data.analysis);
                } else {
                    showAnalysisResults('‚ùå Analysis failed: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Analysis error:', error);
                showAnalysisResults('‚ùå Network error occurred during analysis.');
            });
        }
        
        function displayAnalysisResults(analysis) {
            // Store results for report generation
            storedAnalysisResults = analysis;
            analysisType = 'AI Content Detection Analysis';
            
            const resultsHtml = `
                <div style="border-left: 4px solid ${analysis.color}; padding-left: 1rem; margin-bottom: 2rem;">
                    <h4 style="color: ${analysis.color}; margin-bottom: 0.5rem;">
                        ${analysis.assessment}
                    </h4>
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <div style="background: ${analysis.color}; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold;">
                            ${analysis.confidence_score}% Confidence
                        </div>
                        <div style="background: #f3f4f6; padding: 0.5rem 1rem; border-radius: 20px;">
                            Risk Level: ${analysis.risk_level}
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div>
                        <h5>üìä Text Statistics</h5>
                        <ul style="list-style: none; padding: 0;">
                            <li>üìù Words: ${analysis.text_stats.word_count}</li>
                            <li>üìè Sentences: ${analysis.text_stats.sentence_count}</li>
                            <li>üìê Avg Sentence Length: ${analysis.text_stats.avg_sentence_length} words</li>
                            <li>üî§ Characters: ${analysis.text_stats.character_count}</li>
                        </ul>
                    </div>
                    <div>
                        <h5>üö® AI Indicators Found</h5>
                        ${analysis.indicators.length > 0 ? 
                            '<ul>' + analysis.indicators.map(indicator => `<li>‚Ä¢ ${indicator}</li>`).join('') + '</ul>' :
                            '<p style="color: #2E4B3C;">‚úÖ No significant AI indicators detected</p>'
                        }
                    </div>
                </div>
                
                <div>
                    <h5>üí° Recommendations</h5>
                    <ul>
                        ${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
                
                <div style="margin-top: 2rem; padding: 1rem; background: #f9fafb; border-radius: 8px;">
                    <h6>‚öñÔ∏è Legal Considerations</h6>
                    <p style="margin: 0; font-size: 0.9rem; color: #6b7280;">
                        This analysis is for informational purposes only and should not be the sole basis for legal decisions. 
                        Consider additional forensic analysis and expert testimony for court proceedings.
                    </p>
                </div>
            `;
            
            showAnalysisResults(resultsHtml);
        }
        
        // Character counter for evidence description
        const evidenceDescription = document.getElementById('evidenceDescription');
        const descriptionCount = document.getElementById('descriptionCount');
        
        if (evidenceDescription && descriptionCount) {
            evidenceDescription.addEventListener('input', function() {
                const count = this.value.length;
                descriptionCount.textContent = `${count} characters`;
                descriptionCount.style.color = count < 10 ? '#F0531C' : '#6b7280';
            });
        }
        
        function clearAdmissibility() {
            document.getElementById('evidenceType').value = 'document';
            document.getElementById('evidenceDescription').value = '';
            document.getElementById('sourceInfo').value = '';
            document.getElementById('descriptionCount').textContent = '0 characters';
            document.getElementById('analysisResults').style.display = 'none';
        }
        
        function analyzeAdmissibility() {
            const evidenceType = document.getElementById('evidenceType').value;
            const description = document.getElementById('evidenceDescription').value.trim();
            const source = document.getElementById('sourceInfo').value.trim();
            
            if (description.length < 10) {
                alert('Please provide at least 10 characters for evidence description.');
                return;
            }
            
            // Show loading
            showAnalysisResults('üîÑ Analyzing evidence for legal admissibility under Federal Rules of Evidence...');
            
            // Make API call
            fetch('/api/evidence/legal-admissibility', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    evidence_type: evidenceType,
                    description: description,
                    source: source
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayAdmissibilityResults(data.analysis);
                } else {
                    showAnalysisResults('‚ùå Analysis failed: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Admissibility analysis error:', error);
                showAnalysisResults('‚ùå Network error occurred during analysis.');
            });
        }
        
        function displayAdmissibilityResults(analysis) {
            // Store results for report generation
            storedAnalysisResults = analysis;
            analysisType = 'Legal Admissibility Analysis';
            
            const resultsHtml = `
                <div style="border-left: 4px solid ${analysis.color}; padding-left: 1rem; margin-bottom: 2rem;">
                    <h4 style="color: ${analysis.color}; margin-bottom: 0.5rem;">
                        ${analysis.assessment}
                    </h4>
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <div style="background: ${analysis.color}; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold;">
                            ${analysis.admissibility_score}/100 Score
                        </div>
                        <div style="background: #f3f4f6; padding: 0.5rem 1rem; border-radius: 20px;">
                            Risk: ${analysis.risk_level}
                        </div>
                        <div style="background: #f3f4f6; padding: 0.5rem 1rem; border-radius: 20px;">
                            Type: ${analysis.evidence_summary.type}
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div>
                        <h5>‚ö†Ô∏è Issues Identified</h5>
                        ${analysis.issues.length > 0 ? 
                            '<ul style="list-style: none; padding: 0; font-size: 0.9rem;">' + 
                            analysis.issues.map(issue => `<li style="padding: 0.25rem 0;">‚Ä¢ ${issue}</li>`).join('') + 
                            '</ul>' :
                            '<p style="color: #2E4B3C;">‚úÖ No issues identified</p>'
                        }
                    </div>
                    <div>
                        <h5>üìã Rules Analysis</h5>
                        <ul style="list-style: none; padding: 0; font-size: 0.85rem;">
                            <li><strong>Relevance:</strong> ${analysis.rules_analysis.relevance}</li>
                            <li><strong>Authentication:</strong> ${analysis.rules_analysis.authentication}</li>
                            <li><strong>Hearsay:</strong> ${analysis.rules_analysis.hearsay}</li>
                            <li><strong>Best Evidence:</strong> ${analysis.rules_analysis.best_evidence}</li>
                            <li><strong>Expert Opinion:</strong> ${analysis.rules_analysis.expert_opinion}</li>
                        </ul>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h5>üí° Legal Recommendations</h5>
                    <ul>
                        ${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h5>üìä Evidence Summary</h5>
                    <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; font-size: 0.9rem;">
                        <p><strong>Evidence Type:</strong> ${analysis.evidence_summary.type}</p>
                        <p><strong>Description Length:</strong> ${analysis.evidence_summary.description_length} characters</p>
                        <p><strong>Source Information:</strong> ${analysis.evidence_summary.source_provided ? 'Provided' : 'Not provided'}</p>
                        <p><strong>Analysis Time:</strong> ${new Date(analysis.evidence_summary.analysis_timestamp).toLocaleString()}</p>
                    </div>
                </div>
                
                <div style="margin-top: 2rem; padding: 1rem; background: #f9fafb; border-radius: 8px;">
                    <h6>‚öñÔ∏è Legal Disclaimer</h6>
                    <p style="margin: 0; font-size: 0.9rem; color: #6b7280;">
                        This analysis is based on Federal Rules of Evidence and provides general guidance. Consult with 
                        qualified legal counsel for specific case requirements, state rule variations, and jurisdiction-specific 
                        considerations. Rules of evidence may vary by court and case type.
                    </p>
                </div>
            `;
            
            showAnalysisResults(resultsHtml);
        }
        
        // Store analysis results for report generation
        let storedAnalysisResults = null;
        let analysisType = null;
        
        function updateAvailableAnalysis() {
            const availableDiv = document.getElementById('availableAnalysis');
            const generateBtn = document.getElementById('generateBtn');
            
            if (storedAnalysisResults && analysisType) {
                availableDiv.innerHTML = `
                    <div style="color: #2E4B3C; font-weight: 600;">
                        ‚úì ${analysisType} completed and ready for report generation
                    </div>
                    <div style="font-size: 0.9rem; margin-top: 0.5rem;">
                        Analysis contains ${Object.keys(storedAnalysisResults).length} data points
                    </div>
                `;
                generateBtn.disabled = false;
            } else {
                availableDiv.innerHTML = 'No analysis results available yet. Please run an analysis first.';
                generateBtn.disabled = true;
            }
        }
        
        function showReportGenerator() {
            hideAllInterfaces();
            document.getElementById('reportInterface').style.display = 'block';
            document.getElementById('reportInterface').scrollIntoView({ behavior: 'smooth' });
            updateAvailableAnalysis();
        }
        
        function clearReportForm() {
            document.getElementById('caseName').value = '';
            document.getElementById('caseNumber').value = '';
            document.getElementById('courtName').value = '';
            document.getElementById('attorneyName').value = '';
            document.getElementById('reportType').value = 'comprehensive';
        }
        
        function generateReport() {
            if (!storedAnalysisResults) {
                alert('No analysis results available. Please run an analysis first.');
                return;
            }
            
            const reportData = {
                analysis_results: storedAnalysisResults,
                analysis_type: analysisType,
                case_info: {
                    case_name: document.getElementById('caseName').value || 'Evidence Analysis Report',
                    case_number: document.getElementById('caseNumber').value,
                    court_name: document.getElementById('courtName').value,
                    attorney_name: document.getElementById('attorneyName').value
                },
                report_type: document.getElementById('reportType').value
            };
            
            // Show loading
            showAnalysisResults('üîÑ Generating court-ready report...');
            
            // For now, generate a simple report
            setTimeout(() => {
                displayGeneratedReport(reportData);
            }, 2000);
        }
        
        function displayGeneratedReport(reportData) {
            const reportHtml = `
                <div style="background: #f9fafb; padding: 2rem; border-radius: 8px; margin-bottom: 2rem;">
                    <h4 style="color: #2E4B3C; margin-bottom: 1rem;">üìã Court-Ready Report Generated</h4>
                    
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h5>Report Details:</h5>
                        <ul style="list-style: none; padding: 0;">
                            <li><strong>Case:</strong> ${reportData.case_info.case_name}</li>
                            <li><strong>Case Number:</strong> ${reportData.case_info.case_number || 'Not specified'}</li>
                            <li><strong>Court:</strong> ${reportData.case_info.court_name || 'Not specified'}</li>
                            <li><strong>Attorney:</strong> ${reportData.case_info.attorney_name || 'Not specified'}</li>
                            <li><strong>Report Type:</strong> ${reportData.report_type}</li>
                            <li><strong>Analysis Type:</strong> ${reportData.analysis_type}</li>
                            <li><strong>Generated:</strong> ${new Date().toLocaleString()}</li>
                        </ul>
                    </div>
                    
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h5>Report Sections Included:</h5>
                        <ul>
                            <li>‚úì Executive Summary with key findings</li>
                            <li>‚úì Technical Analysis and methodology</li>
                            <li>‚úì Legal considerations and admissibility</li>
                            <li>‚úì Professional recommendations</li>
                            <li>‚úì Chain of custody documentation</li>
                            <li>‚úì Expert opinion statement</li>
                        </ul>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button class="btn-evidence primary" onclick="downloadReport('pdf')">
                            üìé Download PDF
                        </button>
                        <button class="btn-evidence" onclick="downloadReport('docx')">
                            üìÑ Download Word
                        </button>
                        <button class="btn-evidence" onclick="downloadReport('json')">
                            üìä Export Data
                        </button>
                    </div>
                    
                    <div style="margin-top: 1rem; padding: 1rem; background: #f0f9ff; border-radius: 8px; font-size: 0.9rem;">
                        <strong>Note:</strong> This report is formatted for legal proceedings and includes all necessary 
                        technical documentation, expert opinions, and chain of custody information required for court presentation.
                    </div>
                </div>
            `;
            
            showAnalysisResults(reportHtml);
        }
        
        function downloadReport(format) {
            // This would connect to a backend endpoint for actual file generation
            alert(`Downloading ${format.toUpperCase()} report... (Feature in development)`);
        }
        
        function showAnalysisResults(content) {
            const resultsDiv = document.getElementById('analysisResults');
            const contentDiv = document.getElementById('resultsContent');
            const reportBtn = document.getElementById('generateReportFromResults');
            
            contentDiv.innerHTML = typeof content === 'string' ? `<p>${content}</p>` : content;
            resultsDiv.style.display = 'block';
            
            // Show report generation button if we have stored analysis
            if (storedAnalysisResults && typeof content !== 'string') {
                reportBtn.style.display = 'block';
            } else {
                reportBtn.style.display = 'none';
            }
            
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
{% endblock %}