{% extends "base.html" %}

{% block title %}AI Contract Analysis - LexAI Practice Partner{% endblock %}

{% block extra_head %}
<style>
    .contract-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem 1rem;
        background: #f8fafc;
        min-height: calc(100vh - 4rem);
    }

    .contract-header {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .contract-title {
        font-size: 2.25rem;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .contract-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
    }

    .btn-primary {
        background: #2E4B3C;
        color: white;
    }

    .btn-primary:hover {
        background: #1d2d23;
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: #FFA74F;
        color: #2E4B3C;
    }

    .btn-secondary:hover {
        background: #F0531C;
        transform: translateY(-1px);
    }

    .main-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
    }

    @media (min-width: 1024px) {
        .main-grid {
            grid-template-columns: 1fr 400px;
        }
    }

    .contract-input-section {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .input-tabs {
        display: flex;
        border-bottom: 2px solid #e5e7eb;
        margin-bottom: 2rem;
    }

    .tab-btn {
        padding: 1rem 1.5rem;
        border: none;
        background: transparent;
        cursor: pointer;
        font-weight: 500;
        border-bottom: 2px solid transparent;
        transition: all 0.2s ease;
        color: #6b7280;
    }

    .tab-btn.active {
        color: #2E4B3C;
        border-bottom-color: #2E4B3C;
    }

    .tab-btn:hover:not(.active) {
        color: #374151;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .upload-area {
        border: 2px dashed #d1d5db;
        border-radius: 0.75rem;
        padding: 3rem 2rem;
        text-align: center;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .upload-area:hover {
        border-color: #2E4B3C;
        background: #f9fafb;
    }

    .upload-area.dragover {
        border-color: #2E4B3C;
        background: #f0f9ff;
    }

    .upload-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #6b7280;
    }

    .upload-text {
        color: #374151;
        font-size: 1.125rem;
        margin-bottom: 0.5rem;
    }

    .upload-subtext {
        color: #6b7280;
        font-size: 0.875rem;
    }

    .contract-textarea {
        width: 100%;
        min-height: 400px;
        padding: 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        font-size: 0.875rem;
        line-height: 1.6;
        resize: vertical;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }

    .contract-textarea:focus {
        outline: none;
        border-color: #2E4B3C;
        box-shadow: 0 0 0 3px rgba(46, 75, 60, 0.1);
    }

    .url-input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        font-size: 1rem;
        margin-bottom: 1rem;
    }

    .url-input:focus {
        outline: none;
        border-color: #2E4B3C;
        box-shadow: 0 0 0 3px rgba(46, 75, 60, 0.1);
    }

    .analysis-panel {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .panel-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .analysis-options {
        display: grid;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .option-card {
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .option-card:hover {
        border-color: #2E4B3C;
        background: #f9fafb;
    }

    .option-card.selected {
        border-color: #2E4B3C;
        background: #f0f9ff;
    }

    .option-title {
        font-weight: 600;
        color: #2E4B3C;
        margin-bottom: 0.25rem;
    }

    .option-description {
        font-size: 0.875rem;
        color: #6b7280;
        margin: 0;
    }

    .risk-levels {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        margin-bottom: 2rem;
    }

    .risk-level {
        padding: 0.5rem;
        text-align: center;
        border-radius: 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        color: white;
    }

    .risk-low { background: #10b981; }
    .risk-medium { background: #f59e0b; }
    .risk-high { background: #ef4444; }
    .risk-critical { background: #7c2d12; }

    .loading-spinner {
        display: none;
        text-align: center;
        padding: 2rem;
    }

    .spinner {
        width: 3rem;
        height: 3rem;
        border: 3px solid #e5e7eb;
        border-top: 3px solid #2E4B3C;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .results-section {
        margin-top: 2rem;
        display: none;
    }

    .results-section.active {
        display: block;
    }

    .result-card {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border-left: 4px solid #2E4B3C;
    }

    .result-header {
        display: flex;
        align-items: center;
        justify-content: between;
        margin-bottom: 1rem;
    }

    .result-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
    }

    .result-score {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .score-excellent {
        background: #dcfce7;
        color: #166534;
    }

    .score-good {
        background: #dbeafe;
        color: #1e40af;
    }

    .score-fair {
        background: #fef3c7;
        color: #92400e;
    }

    .score-poor {
        background: #fecaca;
        color: #dc2626;
    }

    .result-content {
        color: #374151;
        line-height: 1.6;
    }

    .clause-list {
        list-style: none;
        padding: 0;
        margin: 1rem 0;
    }

    .clause-item {
        background: #f9fafb;
        border-left: 3px solid #2E4B3C;
        padding: 1rem;
        margin-bottom: 0.5rem;
        border-radius: 0 0.5rem 0.5rem 0;
    }

    .clause-type {
        font-weight: 600;
        color: #2E4B3C;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .clause-text {
        color: #374151;
        margin: 0.5rem 0 0 0;
        font-size: 0.875rem;
    }

    .risk-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        margin-top: 0.5rem;
    }

    .comparison-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 2rem;
    }

    .comparison-section {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .alert {
        padding: 1rem;
        border-radius: 0.75rem;
        margin-bottom: 1rem;
        font-size: 0.875rem;
    }

    .alert-info {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        color: #1e40af;
    }

    .alert-warning {
        background: #fffbeb;
        border: 1px solid #fed7aa;
        color: #92400e;
    }

    .alert-success {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        color: #166534;
    }

    .alert-danger {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #dc2626;
    }

    /* Enhanced Mobile Optimization */
    @media (max-width: 768px) {
        .contract-container {
            padding: 0.75rem;
            min-height: calc(100vh - 2rem);
        }

        .contract-header {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
            padding: 1.5rem 1rem;
            margin-bottom: 1rem;
        }

        .contract-title {
            font-size: 1.75rem;
            text-align: center;
            line-height: 1.2;
        }

        .contract-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            width: 100%;
        }

        .contract-actions .btn {
            width: 100%;
            justify-content: center;
            padding: 1rem;
            font-size: 1rem;
        }

        .main-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .contract-input-section,
        .analysis-panel {
            padding: 1.5rem 1rem;
            margin-bottom: 1rem;
        }

        .input-tabs {
            margin-bottom: 1.5rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-btn {
            padding: 0.875rem 1rem;
            font-size: 0.875rem;
            white-space: nowrap;
            min-width: fit-content;
        }

        .upload-area {
            padding: 2rem 1rem;
            min-height: 120px;
        }

        .upload-icon {
            font-size: 2.5rem;
        }

        .upload-text {
            font-size: 1rem;
        }

        .upload-subtext {
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .contract-textarea {
            min-height: 250px;
            font-size: 1rem;
            padding: 1rem;
        }

        .analysis-options {
            gap: 0.75rem;
        }

        .option-card {
            padding: 1rem;
        }

        .option-title {
            font-size: 1rem;
        }

        .option-description {
            font-size: 0.8rem;
        }

        .risk-levels {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .risk-level {
            padding: 0.75rem 0.5rem;
            font-size: 0.7rem;
        }

        .results-section {
            margin-top: 1rem;
        }

        .result-card {
            padding: 1.5rem 1rem;
            margin-bottom: 1rem;
        }

        .result-header {
            flex-direction: column;
            gap: 0.5rem;
            align-items: stretch;
        }

        .result-title {
            font-size: 1.125rem;
        }

        .result-score {
            align-self: flex-start;
            margin-bottom: 0.5rem;
        }

        .result-content {
            font-size: 0.9rem;
        }

        .clause-item {
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .clause-type {
            font-size: 0.8rem;
        }

        .clause-text {
            font-size: 0.85rem;
        }

        .loading-spinner {
            padding: 2rem 1rem;
        }

        .spinner {
            width: 2.5rem;
            height: 2.5rem;
        }
    }

    /* Small Mobile Devices */
    @media (max-width: 480px) {
        .contract-container {
            padding: 0.5rem;
        }

        .contract-header {
            padding: 1rem;
        }

        .contract-title {
            font-size: 1.5rem;
        }

        .contract-input-section,
        .analysis-panel {
            padding: 1rem;
        }

        .input-tabs {
            flex-wrap: nowrap;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 0.75rem 0.875rem;
            font-size: 0.8rem;
        }

        .upload-area {
            padding: 1.5rem 0.75rem;
            min-height: 100px;
        }

        .upload-icon {
            font-size: 2rem;
        }

        .upload-text {
            font-size: 0.9rem;
        }

        .upload-subtext {
            font-size: 0.75rem;
        }

        .contract-textarea {
            min-height: 200px;
            padding: 0.875rem;
            font-size: 0.9rem;
        }

        .option-card {
            padding: 0.875rem;
        }

        .result-card {
            padding: 1rem;
        }

        .result-title {
            font-size: 1rem;
        }

        .result-content {
            font-size: 0.85rem;
        }

        .risk-levels {
            grid-template-columns: 1fr;
        }

        .risk-level {
            text-align: center;
            padding: 0.75rem;
        }
    }

    /* Touch-Friendly Interactions */
    @media (hover: none) and (pointer: coarse) {
        .btn {
            min-height: 48px;
            padding: 0.875rem 1.25rem;
        }

        .tab-btn {
            min-height: 44px;
        }

        .option-card {
            min-height: 60px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .option-card:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }

        .upload-area {
            min-height: 120px;
            -webkit-tap-highlight-color: transparent;
            position: relative;
            cursor: pointer;
        }

        .upload-area:active {
            transform: scale(0.99);
            transition: transform 0.1s ease;
            background: #e0f2fe !important;
            border-color: #2E4B3C !important;
        }

        /* Enhanced mobile file upload experience */
        .upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 0.75rem;
            background: transparent;
            transition: background 0.2s ease;
            pointer-events: none;
        }

        .upload-area:hover::before {
            background: rgba(46, 75, 60, 0.05);
        }

        .upload-area.dragover::before {
            background: rgba(46, 75, 60, 0.1);
        }

        /* Mobile-specific upload button */
        .mobile-upload-btn {
            display: none;
            background: #2E4B3C;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1rem;
            margin-top: 1rem;
            width: 100%;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .mobile-upload-btn:active {
            background: #1d2d23;
            transform: scale(0.98);
        }

        /* Show mobile upload button on touch devices */
        @media (hover: none) and (pointer: coarse) {
            .mobile-upload-btn {
                display: block;
            }
            
            .upload-area {
                padding: 1.5rem 1rem 0.5rem 1rem;
            }
            
            .upload-subtext {
                margin-bottom: 0.5rem;
            }
        }
    }

    /* Landscape Mobile Orientation */
    @media (max-width: 768px) and (orientation: landscape) {
        .contract-container {
            padding: 0.5rem;
        }

        .contract-header {
            padding: 1rem;
            margin-bottom: 0.5rem;
        }

        .contract-title {
            font-size: 1.5rem;
        }

        .upload-area {
            padding: 1.5rem 1rem;
            min-height: 80px;
        }

        .contract-textarea {
            min-height: 150px;
        }

        .analysis-panel {
            padding: 1rem;
        }
    }
</style>
    <!-- SocketIO for real-time updates -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
{% endblock %}

{% block content %}
<main class="contract-container">
    <!-- Header -->
    <div class="contract-header">
        <h1 class="contract-title">
            🤖 AI Contract Analysis
        </h1>
        <div class="contract-actions">
            <a href="/documents" class="btn btn-secondary">📄 Document Library</a>
            <button class="btn btn-primary" onclick="exportAnalysis()" id="exportBtn" disabled>📊 Export Report</button>
        </div>
    </div>

    <div class="main-grid">
        <!-- Contract Input Section -->
        <div class="contract-input-section">
            <div class="input-tabs">
                <button class="tab-btn active" onclick="switchTab('upload')">📎 Upload Document</button>
                <button class="tab-btn" onclick="switchTab('text')">📝 Paste Text</button>
                <button class="tab-btn" onclick="switchTab('url')">🔗 From URL</button>
            </div>

            <!-- Upload Tab -->
            <div id="upload-tab" class="tab-content active">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">📄</div>
                    <div class="upload-text">Drop your contract(s) here or click to browse</div>
                    <div class="upload-subtext">Supports PDF, DOC, DOCX, TXT, and image files up to 10MB each. Select multiple files for batch processing.</div>
                    <button type="button" class="mobile-upload-btn" id="mobileUploadBtn">
                        📱 Choose Files from Device
                    </button>
                    <input type="file" id="fileInput" style="display: none;" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.tiff,.bmp" multiple>
                </div>
                <div id="fileList" style="margin-top: 1rem;"></div>
            </div>

            <!-- Text Tab -->
            <div id="text-tab" class="tab-content">
                <textarea 
                    class="contract-textarea" 
                    id="contractText" 
                    placeholder="Paste your contract text here...

Example:
EMPLOYMENT AGREEMENT

This Employment Agreement ('Agreement') is entered into on [DATE] between [COMPANY NAME], a [STATE] corporation ('Company'), and [EMPLOYEE NAME] ('Employee').

1. POSITION AND DUTIES
Employee agrees to serve as [POSITION] and to perform such duties...

2. COMPENSATION
Company agrees to pay Employee a salary of $[AMOUNT] per year...

3. TERM
This Agreement shall commence on [START DATE] and continue until...">
                </textarea>
            </div>

            <!-- URL Tab -->
            <div id="url-tab" class="tab-content">
                <input 
                    type="url" 
                    class="url-input" 
                    id="contractUrl" 
                    placeholder="https://example.com/contract.pdf"
                >
                <div class="alert alert-info">
                    <strong>Note:</strong> Only publicly accessible documents can be analyzed from URLs. Ensure the document doesn't contain sensitive information.
                </div>
            </div>

            <button class="btn btn-primary" onclick="startAnalysis()" style="width: 100%; margin-top: 1rem;">
                🔍 Analyze Contract
            </button>
        </div>

        <!-- Analysis Panel -->
        <div class="analysis-panel">
            <h3 class="panel-title">🎯 Analysis Options</h3>
            
            <div class="analysis-options">
                <div class="option-card selected" data-option="comprehensive">
                    <div class="option-title">Comprehensive Analysis</div>
                    <p class="option-description">Full contract review including risks, clauses, and recommendations</p>
                </div>
                
                <div class="option-card" data-option="risk-assessment">
                    <div class="option-title">Risk Assessment</div>
                    <p class="option-description">Focus on identifying potential legal and financial risks</p>
                </div>
                
                <div class="option-card" data-option="clause-extraction">
                    <div class="option-title">Clause Extraction</div>
                    <p class="option-description">Identify and categorize key contract clauses</p>
                </div>
                
                <div class="option-card" data-option="compliance-check">
                    <div class="option-title">Compliance Check</div>
                    <p class="option-description">Verify compliance with standard legal requirements</p>
                </div>
            </div>

            <h4 style="margin-bottom: 1rem;">Risk Level Indicators</h4>
            <div class="risk-levels">
                <div class="risk-level risk-low">Low</div>
                <div class="risk-level risk-medium">Medium</div>
                <div class="risk-level risk-high">High</div>
                <div class="risk-level risk-critical">Critical</div>
            </div>

            <div class="alert alert-info">
                <strong>AI Analysis:</strong> Our AI will analyze your contract for risks, missing clauses, unusual terms, and compliance issues. Results are for informational purposes only and do not constitute legal advice.
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
        <div>Analyzing contract with AI...</div>
        <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
            This may take 30-60 seconds for complex documents
        </div>
    </div>

    <!-- Results Section -->
    <div class="results-section" id="resultsSection">
        <!-- Executive Summary -->
        <div class="result-card">
            <div class="result-header">
                <h3 class="result-title">📋 Executive Summary</h3>
                <span class="result-score score-good" id="overallScore">Good</span>
            </div>
            <div class="result-content" id="executiveSummary">
                <p>AI analysis results will appear here...</p>
            </div>
        </div>

        <!-- Risk Analysis -->
        <div class="result-card">
            <div class="result-header">
                <h3 class="result-title">⚠️ Risk Analysis</h3>
                <span class="result-score score-fair" id="riskScore">Fair</span>
            </div>
            <div class="result-content" id="riskAnalysis">
                <ul class="clause-list" id="riskList">
                    <!-- Risk items will be populated here -->
                </ul>
            </div>
        </div>

        <!-- Key Clauses -->
        <div class="result-card">
            <div class="result-header">
                <h3 class="result-title">📝 Key Clauses Identified</h3>
            </div>
            <div class="result-content">
                <ul class="clause-list" id="clauseList">
                    <!-- Clause items will be populated here -->
                </ul>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="result-card">
            <div class="result-header">
                <h3 class="result-title">💡 Recommendations</h3>
            </div>
            <div class="result-content" id="recommendations">
                <!-- Recommendations will be populated here -->
            </div>
        </div>
    </div>
</main>

<script>
    let currentTab = 'upload';
    let selectedOption = 'comprehensive';
    let uploadedFiles = [];
    let socket = null;
    
    // Initialize WebSocket connection for real-time updates
    function initializeWebSocket() {
        try {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server for real-time updates');
            });
            
            socket.on('analysis_progress', function(data) {
                updateProgressDisplay(data);
            });
            
            socket.on('disconnect', function() {
                console.log('Disconnected from server');
            });
            
        } catch (error) {
            console.log('WebSocket not available, falling back to polling');
            socket = null;
        }
    }
    
    function updateProgressDisplay(progressData) {
        const loadingSpinner = document.getElementById('loadingSpinner');
        if (!loadingSpinner || loadingSpinner.style.display === 'none') {
            return; // Only show updates if analysis is in progress
        }
        
        const loadingText = loadingSpinner.querySelector('div:nth-child(2)');
        const subText = loadingSpinner.querySelector('div:nth-child(3)');
        
        switch (progressData.type) {
            case 'batch_start':
                loadingText.textContent = progressData.message;
                subText.textContent = `Processing ${progressData.total_files} files...`;
                break;
                
            case 'file_start':
                loadingText.textContent = progressData.message;
                subText.textContent = `File ${progressData.current_file} of ${progressData.total_files}`;
                break;
                
            case 'extraction':
                subText.textContent = `Extracting text from ${progressData.filename}...`;
                break;
                
            case 'analysis':
                subText.textContent = `Running AI analysis on ${progressData.filename}...`;
                break;
                
            case 'file_complete':
                const percent = Math.round(progressData.progress_percent);
                subText.textContent = `Progress: ${percent}% complete (${progressData.current_file}/${progressData.total_files} files)`;
                break;
                
            case 'batch_complete':
                loadingText.textContent = progressData.message;
                subText.textContent = `Success rate: ${Math.round(progressData.success_rate)}%`;
                break;
        }
    }
    
    // Initialize WebSocket when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initializeWebSocket();
    });

    // Tab switching
    function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).classList.add('active');
        
        currentTab = tabName;
    }

    // Analysis option selection
    document.querySelectorAll('.option-card').forEach(card => {
        card.addEventListener('click', function() {
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            selectedOption = this.getAttribute('data-option');
        });
    });

    // File upload handling
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const mobileUploadBtn = document.getElementById('mobileUploadBtn');

    // Enhanced mobile-friendly upload handling
    uploadArea.addEventListener('click', (e) => {
        // Prevent double-triggering on mobile
        if (e.target === mobileUploadBtn) return;
        fileInput.click();
    });
    
    // Mobile upload button
    if (mobileUploadBtn) {
        mobileUploadBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.click();
        });
        
        // Add haptic feedback on supported devices
        mobileUploadBtn.addEventListener('touchstart', () => {
            if (window.navigator && window.navigator.vibrate) {
                window.navigator.vibrate(50);
            }
        });
    }
    
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('drop', handleDrop);
    uploadArea.addEventListener('dragleave', handleDragLeave);
    fileInput.addEventListener('change', handleFileSelect);

    function handleDragOver(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    }

    function handleDrop(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
    }

    function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        handleFiles(files);
    }

    function handleFiles(files) {
        uploadedFiles = files;
        updateFileList();
    }

    function updateFileList() {
        fileList.innerHTML = uploadedFiles.map((file, index) => `
            <div class="file-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.75rem; margin-bottom: 0.75rem; border-left: 4px solid #2E4B3C;">
                <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        📄 ${file.name}
                    </div>
                    <div style="font-size: 0.875rem; color: #6b7280;">
                        ${formatFileSize(file.size)} • ${getFileTypeDisplay(file.type || file.name)}
                    </div>
                </div>
                <button 
                    onclick="removeFile(${index})" 
                    style="background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; cursor: pointer; padding: 0.5rem; border-radius: 0.5rem; margin-left: 0.75rem; min-width: 40px; min-height: 40px; transition: all 0.2s ease; -webkit-tap-highlight-color: transparent;"
                    onmouseover="this.style.background='#fee2e2'"
                    onmouseout="this.style.background='#fef2f2'"
                    ontouchstart="this.style.background='#fee2e2'"
                    ontouchend="this.style.background='#fef2f2'"
                >✕</button>
            </div>
        `).join('');
    }

    function removeFile(index) {
        uploadedFiles.splice(index, 1);
        updateFileList();
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function getFileTypeDisplay(fileType) {
        if (typeof fileType === 'string') {
            if (fileType.includes('pdf')) return 'PDF Document';
            if (fileType.includes('word') || fileType.includes('doc')) return 'Word Document';
            if (fileType.includes('text')) return 'Text File';
            if (fileType.includes('image')) return 'Image File';
        }
        
        // Fallback to file extension
        const extension = fileType.split('.').pop()?.toLowerCase();
        switch (extension) {
            case 'pdf': return 'PDF Document';
            case 'doc':
            case 'docx': return 'Word Document';
            case 'txt': return 'Text File';
            case 'jpg':
            case 'jpeg':
            case 'png':
            case 'tiff':
            case 'bmp': return 'Image File';
            default: return 'Document';
        }
    }

    // Start analysis
    async function startAnalysis() {
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultsSection = document.getElementById('resultsSection');
        
        // Validate input
        let hasInput = false;
        if (currentTab === 'upload' && uploadedFiles.length > 0) {
            hasInput = true;
        } else if (currentTab === 'text' && document.getElementById('contractText').value.trim()) {
            hasInput = true;
        } else if (currentTab === 'url' && document.getElementById('contractUrl').value.trim()) {
            hasInput = true;
        }

        if (!hasInput) {
            alert('Please provide a contract to analyze');
            return;
        }

        // Show loading state
        loadingSpinner.style.display = 'block';
        resultsSection.classList.remove('active');

        try {
            let results;
            
            if (currentTab === 'upload') {
                // Handle file upload
                const file = uploadedFiles[0];
                
                // Create FormData for file upload
                const formData = new FormData();
                formData.append('file', file);
                formData.append('type', selectedOption);
                formData.append('source', 'file');
                
                const response = await fetch('/api/ai/contract-analysis', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (result.success) {
                    results = result.data;
                } else {
                    displayDetailedError(result);
                    return;
                }
            } else {
                // Handle text or URL input
                const analysisData = {
                    type: selectedOption,
                    source: currentTab
                };
                
                if (currentTab === 'text') {
                    analysisData.text = document.getElementById('contractText').value;
                } else if (currentTab === 'url') {
                    analysisData.text = document.getElementById('contractUrl').value; // Treat URL as text for now
                    analysisData.source = 'url';
                }
                
                const response = await fetch('/api/ai/contract-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(analysisData)
                });
                
                const result = await response.json();
                if (result.success) {
                    results = result.data;
                } else {
                    displayDetailedError(result);
                    return;
                }
            }
            
            // Handle both single and batch results
            if (results.batch_processing) {
                displayBatchResults(results);
            } else {
                displayResults(results);
            }

            loadingSpinner.style.display = 'none';
            resultsSection.classList.add('active');
            
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });

        } catch (error) {
            console.error('Analysis error:', error);
            displayErrorMessage('An unexpected error occurred. Please try again.');
            loadingSpinner.style.display = 'none';
        }
    }

    function generateMockAnalysis(data) {
        const riskLevels = ['Low', 'Medium', 'High', 'Critical'];
        const clauseTypes = ['Termination', 'Confidentiality', 'Indemnification', 'Limitation of Liability', 'Governing Law', 'Force Majeure'];
        
        return {
            overallScore: 'Good',
            summary: `This ${data.source === 'upload' ? data.fileName || 'document' : 'contract'} has been analyzed using advanced AI. The contract appears to be well-structured with standard clauses, though some areas require attention.`,
            risks: [
                {
                    level: 'Medium',
                    type: 'Termination Clause',
                    description: 'Termination clause may be too restrictive for one party',
                    recommendation: 'Consider adding mutual termination rights'
                },
                {
                    level: 'Low',
                    type: 'Payment Terms',
                    description: 'Payment terms are standard but could include late fees',
                    recommendation: 'Add penalty clauses for late payments'
                }
            ],
            clauses: [
                {
                    type: 'Confidentiality',
                    content: 'Standard confidentiality provisions detected',
                    status: 'Present'
                },
                {
                    type: 'Indemnification',
                    content: 'Mutual indemnification clause found',
                    status: 'Present'
                },
                {
                    type: 'Force Majeure',
                    content: 'No force majeure clause detected',
                    status: 'Missing'
                }
            ],
            recommendations: [
                'Add a force majeure clause to protect against unforeseen circumstances',
                'Consider including dispute resolution mechanisms',
                'Review termination notice periods for adequacy',
                'Ensure compliance with applicable state laws'
            ]
        };
    }

    function displayBatchResults(batchData) {
        // Handle batch processing results
        const resultsContainer = document.getElementById('resultsSection');
        const summary = batchData.summary;
        
        // Create batch summary header
        const batchSummaryHtml = `
            <div class="result-card" style="border-left: 4px solid #3b82f6;">
                <div class="result-header">
                    <h3 class="result-title">📊 Batch Processing Summary</h3>
                    <span class="result-score ${summary.success_rate >= 80 ? 'score-excellent' : summary.success_rate >= 60 ? 'score-good' : 'score-fair'}">
                        ${Math.round(summary.success_rate)}% Success
                    </span>
                </div>
                <div class="result-content">
                    <p><strong>Total Files:</strong> ${summary.total_files}</p>
                    <p><strong>Successful Analyses:</strong> ${summary.successful_analyses}</p>
                    <p><strong>Failed Analyses:</strong> ${summary.failed_analyses}</p>
                    <p><strong>Analysis Type:</strong> ${summary.analysis_type}</p>
                    <p><strong>Processing Time:</strong> ${new Date(summary.processing_time).toLocaleString()}</p>
                </div>
            </div>
        `;
        
        // Create individual file results
        const fileResultsHtml = batchData.results.map((result, index) => {
            if (result.status === 'success') {
                const analysis = result.analysis;
                return `
                    <div class="result-card" style="border-left: 4px solid #10b981;">
                        <div class="result-header">
                            <h3 class="result-title">📄 ${result.filename}</h3>
                            <span class="result-score score-good">Success</span>
                        </div>
                        <div class="result-content">
                            <p><strong>File Size:</strong> ${(result.file_metadata.file_size / 1024).toFixed(1)} KB</p>
                            <p><strong>Text Length:</strong> ${result.text_length} characters</p>
                            <p><strong>Overall Score:</strong> ${analysis.overall_score || 'N/A'}</p>
                            <p><strong>Summary:</strong> ${analysis.executive_summary || analysis.summary || 'Analysis completed'}</p>
                            
                            <h4 style="margin-top: 1rem; color: #2E4B3C;">Key Risks Identified:</h4>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                ${analysis.risks ? analysis.risks.slice(0, 3).map(risk => 
                                    `<li><strong>${risk.type}:</strong> ${risk.description}</li>`
                                ).join('') : '<li>No significant risks identified</li>'}
                            </ul>
                            
                            ${result.citation_analysis && result.citation_analysis.citations.length > 0 ? `
                                <h4 style="margin-top: 1rem; color: #2E4B3C;">Legal Citations Found:</h4>
                                <p>${result.citation_analysis.citations.length} citations detected</p>
                            ` : ''}
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="result-card" style="border-left: 4px solid #ef4444;">
                        <div class="result-header">
                            <h3 class="result-title">❌ ${result.filename}</h3>
                            <span class="result-score score-poor">Failed</span>
                        </div>
                        <div class="result-content">
                            <p><strong>Error:</strong> ${result.error}</p>
                            <p><strong>File Size:</strong> ${(result.file_metadata.file_size / 1024).toFixed(1)} KB</p>
                            <p><strong>File Type:</strong> ${result.file_metadata.file_type}</p>
                        </div>
                    </div>
                `;
            }
        }).join('');
        
        // Update the results section
        resultsContainer.innerHTML = batchSummaryHtml + fileResultsHtml;
        
        // Update page title elements
        document.getElementById('executiveSummary').innerHTML = `<p>Batch processing completed for ${summary.total_files} files with ${summary.success_rate.toFixed(1)}% success rate.</p>`;
        document.getElementById('overallScore').textContent = `${Math.round(summary.success_rate)}%`;
        document.getElementById('overallScore').className = `result-score ${summary.success_rate >= 80 ? 'score-excellent' : summary.success_rate >= 60 ? 'score-good' : 'score-fair'}`;
    }

    let currentExportId = null; // Store export ID for current analysis

    function displayResults(results) {
        // Handle both AI-powered and fallback results
        const isAiPowered = results.ai_powered !== false;
        
        // Enable export button if export is available
        currentExportId = results.export_id;
        const exportBtn = document.getElementById('exportBtn');
        if (currentExportId && results.export_available) {
            exportBtn.disabled = false;
            exportBtn.textContent = '📊 Export Report';
        } else {
            exportBtn.disabled = true;
            exportBtn.textContent = '📊 Export Not Available';
        }
        
        // Overall score - handle different response formats
        let scoreText, scoreClass;
        if (results.overall_score) {
            if (typeof results.overall_score === 'object') {
                scoreText = results.overall_score.grade || results.overall_score.score || 'N/A';
                scoreClass = `score-${scoreText.toLowerCase()}`;
            } else {
                scoreText = results.overall_score;
                scoreClass = `score-${scoreText.toLowerCase()}`;
            }
        } else {
            scoreText = results.overallScore || 'N/A';
            scoreClass = `score-${scoreText.toLowerCase()}`;
        }
        
        document.getElementById('overallScore').textContent = scoreText;
        document.getElementById('overallScore').className = `result-score ${scoreClass}`;

        // Executive summary
        const summary = results.executive_summary || results.summary || 'Analysis completed successfully.';
        document.getElementById('executiveSummary').innerHTML = `<p>${summary}</p>`;
        
        // Add AI indicator
        if (isAiPowered) {
            document.getElementById('executiveSummary').innerHTML += `<p class="ai-indicator" style="margin-top: 1rem; padding: 0.5rem; background: #e8f5e8; border-radius: 0.5rem; font-size: 0.875rem; color: #2d5016;"><strong>🤖 AI-Powered Analysis:</strong> This analysis was generated using advanced AI with ${Math.round((results.confidence_score || 0.92) * 100)}% confidence.</p>`;
        }

        // Risk analysis
        document.getElementById('riskList').innerHTML = results.risks.map(risk => `
            <li class="clause-item">
                <div class="clause-type">${risk.type}</div>
                <div class="clause-text">${risk.description}</div>
                <div class="risk-indicator risk-${risk.level.toLowerCase()}">${risk.level} Risk</div>
                <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #2E4B3C;">
                    <strong>Recommendation:</strong> ${risk.recommendation}
                </div>
            </li>
        `).join('');

        // Key clauses
        document.getElementById('clauseList').innerHTML = results.clauses.map(clause => `
            <li class="clause-item">
                <div class="clause-type">${clause.type}</div>
                <div class="clause-text">${clause.content}</div>
                <div class="risk-indicator ${clause.status === 'Present' ? 'risk-low' : 'risk-medium'}">
                    ${clause.status}
                </div>
            </li>
        `).join('');

        // Recommendations
        document.getElementById('recommendations').innerHTML = `
            <ul style="list-style: none; padding: 0;">
                ${results.recommendations.map(rec => `
                    <li style="margin-bottom: 0.75rem; padding-left: 1.5rem; position: relative;">
                        <span style="position: absolute; left: 0; color: #2E4B3C;">💡</span>
                        ${rec}
                    </li>
                `).join('')}
            </ul>
        `;
    }

    function displayDetailedError(errorData) {
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultsSection = document.getElementById('resultsSection');
        
        loadingSpinner.style.display = 'none';
        
        // Create error display HTML
        const errorHtml = `
            <div class="result-card" style="border-left: 4px solid #ef4444; background: #fef2f2;">
                <div class="result-header">
                    <h3 class="result-title" style="color: #dc2626;">❌ Analysis Failed</h3>
                    <span class="result-score score-poor">${errorData.error_code || 'ERROR'}</span>
                </div>
                <div class="result-content">
                    <p style="color: #dc2626; font-weight: 600; margin-bottom: 1rem;">
                        ${errorData.error || errorData.user_message || 'An error occurred during analysis.'}
                    </p>
                    
                    ${errorData.suggestions && errorData.suggestions.length > 0 ? `
                        <h4 style="color: #dc2626; margin-bottom: 0.5rem;">💡 Suggestions to Fix This:</h4>
                        <ul style="color: #374151; margin: 0.5rem 0; padding-left: 1.5rem;">
                            ${errorData.suggestions.map(suggestion => `<li style="margin-bottom: 0.5rem;">${suggestion}</li>`).join('')}
                        </ul>
                    ` : ''}
                    
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #f3f4f6; border-radius: 0.5rem;">
                        <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">
                            <strong>Need Help?</strong> Contact support at support@lexai.com with error code: 
                            <code style="background: #e5e7eb; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">${errorData.error_code || 'UNKNOWN'}</code>
                        </p>
                    </div>
                </div>
            </div>
        `;
        
        resultsSection.innerHTML = errorHtml;
        resultsSection.classList.add('active');
        resultsSection.scrollIntoView({ behavior: 'smooth' });
        
        // Track error event
        if (typeof gtag !== 'undefined') {
            gtag('event', 'exception', {
                'description': errorData.error_code || 'unknown_error',
                'fatal': false
            });
        }
    }
    
    function displayErrorMessage(message) {
        // Simple error message fallback
        displayDetailedError({
            error: message,
            error_code: 'GENERIC_ERROR',
            suggestions: [
                'Try again in a few moments',
                'Check your internet connection',
                'Contact support if the problem persists'
            ]
        });
    }

    function exportAnalysis() {
        if (!currentExportId) {
            alert('No analysis available for export. Please run an analysis first.');
            return;
        }
        
        // Show loading state
        const exportBtn = document.getElementById('exportBtn');
        const originalText = exportBtn.textContent;
        exportBtn.disabled = true;
        exportBtn.textContent = '📊 Generating Report...';
        
        try {
            // Generate export URL and open in new tab
            const exportUrl = `/api/export/contract-analysis/${currentExportId}`;
            window.open(exportUrl, '_blank');
            
            // Track export event
            if (typeof gtag !== 'undefined') {
                gtag('event', 'export', {
                    event_category: 'contract_analysis',
                    event_label: 'pdf_report',
                    value: 1
                });
            }
            
            // Show success message
            setTimeout(() => {
                alert('Report export initiated! Check your downloads folder.');
                exportBtn.disabled = false;
                exportBtn.textContent = originalText;
            }, 1000);
            
        } catch (error) {
            console.error('Export error:', error);
            alert('Export failed. Please try again.');
            exportBtn.disabled = false;
            exportBtn.textContent = originalText;
        }
    }

    // Track page view
    if (typeof gtag !== 'undefined') {
        gtag('event', 'page_view', {
            page_title: 'AI Contract Analysis',
            page_location: window.location.href
        });
    }
</script>
{% endblock %}