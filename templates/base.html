<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}LexAI Practice Partner{% endblock %}</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    
    <!-- Google Analytics -->
    {% if google_analytics_id %}
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ google_analytics_id }}"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', '{{ google_analytics_id }}');
        
        // Custom event tracking functions
        function trackEvent(action, category, label, value) {
            gtag('event', action, {
                event_category: category,
                event_label: label,
                value: value
            });
        }
        
        // Track page-specific events
        function trackPageView(pageName) {
            gtag('event', 'page_view', {
                page_title: pageName,
                page_location: window.location.href
            });
        }
        
        // Track user interactions
        function trackUserAction(action, details) {
            gtag('event', 'user_interaction', {
                event_category: 'engagement',
                event_label: action,
                custom_parameter: details
            });
        }
    </script>
    {% endif %}
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/landing.css?v={{ cache_buster }}">
    
    <!-- Override for dashboard button styling - ONLY on non-admin pages -->
    {% if not request.endpoint or not request.endpoint.startswith('admin_') %}
    <style>
        .main-nav a.nav-item.active {
            background-color: #FFA74F !important; /* warm-orange */
            color: #2E4B3C !important; /* dark-green */
            padding: 0.5rem 1.5rem !important;
            border-radius: 0.5rem !important;
            font-weight: 600 !important;
            text-decoration: none !important;
            transition: all 0.2s ease !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
        }
        
        .main-nav a.nav-item.active:hover {
            background-color: #F0531C !important; /* bright-coral */
            color: #2E4B3C !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
        }
    </style>
    {% endif %}
    
    <!-- Authentication and User Menu Styles -->
    <style>
        .base-user-avatar {
            width: 2.5rem;
            height: 2.5rem;
            background: linear-gradient(135deg, #2E4B3C, #4a7c59);
            color: #F7EDDA;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .base-user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(46, 75, 60, 0.3);
        }

        .base-user-dropdown {
            right: 0;
            min-width: 280px;
            padding: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .base-user-info {
            padding: 1rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .base-user-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .base-user-email {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .base-user-divider {
            height: 1px;
            background: #f3f4f6;
            margin: 0.5rem 0;
        }

        .base-dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: #374151;
            text-decoration: none;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .base-dropdown-item:hover {
            background-color: #f9fafb;
            color: #1f2937;
            text-decoration: none;
        }

        .base-dropdown-item svg {
            width: 1rem;
            height: 1rem;
            color: #6b7280;
        }

        .base-dropdown-item:hover svg {
            color: #2E4B3C;
        }

        /* Mobile responsiveness for user menu */
        @media (max-width: 768px) {
            .base-user-dropdown {
                min-width: 260px;
                right: -1rem;
            }
        }
    </style>
    
    {% block extra_head %}{% endblock %}
</head>
<body>
    <!-- Header Navigation -->
    <header class="base-navbar">
        <div class="base-nav-container">
            <div class="base-nav-content">
                <!-- Logo - Always goes to homepage -->
                <div>
                    <a href="{{ url_for('landing_page') }}">
                        <img src="/static/lexAI.png" alt="LexAI" style="height: 3rem; width: auto;">
                    </a>
                </div>
                
                <!-- APPLE-STYLE NESTED NAVIGATION -->
                <nav class="main-nav">
                    <a href="{{ url_for('dashboard') }}" class="nav-item dashboard-btn">Dashboard</a>
                    
                    <div class="nav-item dropdown">
                        <a href="{{ url_for('cases_page') }}" class="nav-link">Cases</a>
                        <div class="dropdown-content" data-category="Case Management">
                            <a href="{{ url_for('cases_page') }}">
                                <span class="menu-icon">üìã</span>
                                All Cases
                            </a>
                            <a href="{{ url_for('clients_page') }}">
                                <span class="menu-icon">üë•</span>
                                Clients
                            </a>
                            <a href="{{ url_for('deadlines_page') }}">
                                <span class="menu-icon">‚è∞</span>
                                Deadlines
                            </a>
                            <a href="{{ url_for('calendar_page') }}">
                                <span class="menu-icon">üìÖ</span>
                                Calendar
                            </a>
                        </div>
                    </div>
                    
                    <div class="nav-item dropdown">
                        <a href="{{ url_for('documents_page') }}" class="nav-link">Documents</a>
                        <div class="dropdown-content" data-category="Document Center">
                            <a href="{{ url_for('documents_page') }}">
                                <span class="menu-icon">üìÑ</span>
                                Document Library
                            </a>
                            <a href="{{ url_for('document_analysis_page') }}">
                                <span class="menu-icon">üîç</span>
                                AI Analysis
                            </a>
                            <a href="{{ url_for('contracts_page') }}">
                                <span class="menu-icon">üìù</span>
                                Contracts
                            </a>
                        </div>
                    </div>
                    
                    <div class="nav-item dropdown">
                        <a href="{{ url_for('chat_page') }}" class="nav-link">AI Tools</a>
                        <div class="dropdown-content" data-category="AI Assistant">
                            <a href="{{ url_for('chat_page') }}">
                                <span class="menu-icon">ü§ñ</span>
                                Legal Assistant
                            </a>
                            <a href="{{ url_for('ai_legal_research') }}">
                                <span class="menu-icon">üîç</span>
                                Legal Research
                            </a>
                            <a href="{{ url_for('ai_contract_analysis') }}">
                                <span class="menu-icon">üìã</span>
                                Contract Analysis
                            </a>
                            <a href="{{ url_for('ai_document_comparison') }}">
                                <span class="menu-icon">üîÑ</span>
                                Document Comparison
                            </a>
                            <a href="{{ url_for('document_analysis_page') }}">
                                <span class="menu-icon">üìä</span>
                                Document Analysis
                            </a>
                        </div>
                    </div>
                    
                    <div class="nav-item dropdown">
                        <a href="{{ url_for('billing_page') }}" class="nav-link">Business</a>
                        <div class="dropdown-content" data-category="Operations">
                            <a href="{{ url_for('time_tracking_page') }}">
                                <span class="menu-icon">‚è±Ô∏è</span>
                                Time Tracking
                            </a>
                            <a href="{{ url_for('billing_page') }}">
                                <span class="menu-icon">üí∞</span>
                                Billing
                            </a>
                            <a href="{{ url_for('analytics_dashboard') }}">
                                <span class="menu-icon">üìà</span>
                                Analytics
                            </a>
                        </div>
                    </div>
                    
                    <div class="nav-item dropdown">
                        <a href="/admin" class="nav-link">Admin</a>
                        <div class="dropdown-content" data-category="Administration">
                            <a href="/admin/users">
                                <span class="menu-icon">üë§</span>
                                Users
                            </a>
                            <a href="/admin/settings">
                                <span class="menu-icon">‚öôÔ∏è</span>
                                Settings
                            </a>
                            <a href="/admin/subscriptions">
                                <span class="menu-icon">üí≥</span>
                                Subscriptions
                            </a>
                            <a href="/admin/audit-logs">
                                <span class="menu-icon">üìã</span>
                                Audit Logs
                            </a>
                        </div>
                    </div>
                </nav>
                
                <!-- User Menu -->
                <div class="base-user-menu">
                    <!-- User Profile Dropdown -->
                    <div class="base-dropdown">
                        <button class="base-user-avatar" id="userMenuButton">
                            <span id="userInitials">DU</span>
                        </button>
                        <div class="base-dropdown-menu base-user-dropdown" style="display: none;">
                            <div class="base-user-info">
                                <div class="base-user-name" id="userName">Demo User</div>
                                <div class="base-user-email" id="userEmail">demo@lexai.com</div>
                            </div>
                            <div class="base-user-divider"></div>
                            <a href="/profile" class="base-dropdown-item">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                Account Settings
                            </a>
                            <a href="/security/2fa" class="base-dropdown-item">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 1l3 3h4a2 2 0 012 2v8a2 2 0 01-2 2h-4l-3 3-3-3H5a2 2 0 01-2-2V6a2 2 0 012-2h4l3-3z"/>
                                    <path d="M9 12l2 2 4-4"/>
                                </svg>
                                Two-Factor Auth
                            </a>
                            <a href="#" class="base-dropdown-item">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                    <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                Preferences
                            </a>
                            <a href="#" class="base-dropdown-item">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Help & Support
                            </a>
                            <div class="base-user-divider"></div>
                            <button class="base-dropdown-item" onclick="handleLogout()" style="width: 100%; text-align: left; background: none; border: none; padding: 0.75rem 1rem; cursor: pointer;">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                </svg>
                                Sign Out
                            </button>
                        </div>
                    </div>
                    
                    <!-- Mobile menu button -->
                    <button id="mobile-menu-button" class="base-mobile-btn">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mobile Navigation - NESTED ACCORDION STYLE -->
        <div id="mobile-menu" class="base-mobile-menu hidden">
            <div class="base-mobile-nav">
                <!-- Dashboard -->
                <a href="{{ url_for('dashboard') }}" 
                   class="base-mobile-link mobile-dashboard-btn">
                    üè† Dashboard
                </a>
                
                <!-- Cases Section -->
                <div class="mobile-accordion-section">
                    <button class="mobile-accordion-header {% if request.endpoint in ['cases_page', 'case_detail', 'clients_page', 'client_detail', 'deadlines_page', 'calendar_page'] %}parent-active{% endif %}" data-section="cases">
                        <span>üìã Cases</span>
                        <svg class="mobile-accordion-chevron" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="mobile-accordion-content" id="cases-content">
                        <a href="{{ url_for('cases_page') }}" 
                           class="base-mobile-link submenu {% if request.endpoint in ['cases_page', 'case_detail'] %}active{% endif %}">
                            üìã All Cases
                        </a>
                        <a href="{{ url_for('clients_page') }}" 
                           class="base-mobile-link submenu {% if request.endpoint in ['clients_page', 'client_detail'] %}active{% endif %}">
                            üë• Clients
                        </a>
                        <a href="{{ url_for('deadlines_page') }}" 
                           class="base-mobile-link submenu {% if request.endpoint == 'deadlines_page' %}active{% endif %}">
                            ‚è∞ Deadlines
                        </a>
                        <a href="{{ url_for('calendar_page') }}" 
                           class="base-mobile-link submenu {% if request.endpoint == 'calendar_page' %}active{% endif %}">
                            üìÖ Calendar
                        </a>
                    </div>
                </div>
                
                <!-- Documents Section -->
                <div class="mobile-accordion-section">
                    <button class="mobile-accordion-header {% if request.endpoint in ['documents_page', 'document_analysis_page', 'contracts_page'] %}parent-active{% endif %}" data-section="documents">
                        <span>üìÑ Documents</span>
                        <svg class="mobile-accordion-chevron" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="mobile-accordion-content" id="documents-content">
                        <a href="{{ url_for('documents_page') }}" 
                           class="base-mobile-link submenu {% if request.endpoint == 'documents_page' %}active{% endif %}">
                            üìÑ Document Library
                        </a>
                        <a href="{{ url_for('document_analysis_page') }}" 
                           class="base-mobile-link submenu {% if request.endpoint == 'document_analysis_page' %}active{% endif %}">
                            üîç AI Analysis
                        </a>
                        <a href="{{ url_for('contracts_page') }}" 
                           class="base-mobile-link submenu {% if request.endpoint == 'contracts_page' %}active{% endif %}">
                            üìù Contracts
                        </a>
                    </div>
                </div>
                
                <!-- AI Tools Section -->
                <div class="mobile-accordion-section">
                    <button class="mobile-accordion-header {% if request.endpoint in ['chat_page', 'legal_research_page', 'document_analysis_page'] %}parent-active{% endif %}" data-section="ai-tools">
                        <span>ü§ñ AI Tools</span>
                        <svg class="mobile-accordion-chevron" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="mobile-accordion-content" id="ai-tools-content">
                        <a href="{{ url_for('chat_page') }}" 
                           class="base-mobile-link submenu {% if request.endpoint == 'chat_page' %}active{% endif %}">
                            ü§ñ Legal Assistant
                        </a>
                        <a href="{{ url_for('legal_research_page') }}" 
                           class="base-mobile-link submenu {% if request.endpoint == 'legal_research_page' %}active{% endif %}">
                            üî¨ Research
                        </a>
                        <a href="{{ url_for('document_analysis_page') }}" 
                           class="base-mobile-link submenu {% if request.endpoint == 'document_analysis_page' %}active{% endif %}">
                            üìä Document Analysis
                        </a>
                    </div>
                </div>
                
                <!-- Business Section -->
                <div class="mobile-accordion-section">
                    <button class="mobile-accordion-header {% if request.endpoint in ['time_tracking_page', 'billing_page', 'expense_tracking_page', 'analytics_dashboard'] %}parent-active{% endif %}" data-section="business">
                        <span>üíº Business</span>
                        <svg class="mobile-accordion-chevron" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="mobile-accordion-content" id="business-content">
                        <a href="{{ url_for('time_tracking_page') }}" 
                           class="base-mobile-link submenu {% if request.endpoint == 'time_tracking_page' %}active{% endif %}">
                            ‚è±Ô∏è Time Tracking
                        </a>
                        <a href="{{ url_for('billing_page') }}" 
                           class="base-mobile-link submenu {% if request.endpoint in ['billing_page', 'expense_tracking_page'] %}active{% endif %}">
                            üí∞ Billing
                        </a>
                        <a href="{{ url_for('analytics_dashboard') }}" 
                           class="base-mobile-link submenu {% if request.endpoint == 'analytics_dashboard' %}active{% endif %}">
                            üìà Analytics
                        </a>
                    </div>
                </div>
                
                <!-- Admin Section -->
                <div class="mobile-accordion-section">
                    <button class="mobile-accordion-header {% if request.endpoint and request.endpoint.startswith('admin_') %}parent-active{% endif %}" data-section="admin">
                        <span>‚öôÔ∏è Admin</span>
                        <svg class="mobile-accordion-chevron" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="mobile-accordion-content" id="admin-content">
                        <a href="/admin/users" 
                           class="base-mobile-link submenu">
                            üë§ Users
                        </a>
                        <a href="/admin/settings" 
                           class="base-mobile-link submenu">
                            ‚öôÔ∏è Settings
                        </a>
                        <a href="/admin/subscriptions" 
                           class="base-mobile-link submenu">
                            üí≥ Subscriptions
                        </a>
                        <a href="/admin/audit-logs" 
                           class="base-mobile-link submenu">
                            üìã Audit Logs
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        {% block content %}{% endblock %}
    </main>
    
    <!-- Footer -->
    <footer class="base-footer">
        <div class="base-footer-container">
            <div class="base-footer-content">
                ¬© 2025 LexAI Practice Partner. Professional AI assistant for legal practices.
            </div>
        </div>
    </footer>

    <!-- Base JavaScript -->
    <script>
        // Mobile menu toggle
        document.getElementById('mobile-menu-button').addEventListener('click', function() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        });

        // Mobile accordion functionality
        document.querySelectorAll('.mobile-accordion-header').forEach(header => {
            header.addEventListener('click', function() {
                const section = this.dataset.section;
                const content = document.getElementById(section + '-content');
                const chevron = this.querySelector('.mobile-accordion-chevron');
                
                // Toggle active state
                const isActive = this.classList.contains('active');
                
                // Close all other sections (accordion behavior)
                document.querySelectorAll('.mobile-accordion-header').forEach(h => {
                    if (h !== this) {
                        h.classList.remove('active');
                        const otherContent = document.getElementById(h.dataset.section + '-content');
                        if (otherContent) {
                            otherContent.classList.remove('active');
                        }
                    }
                });
                
                // Toggle current section
                if (isActive) {
                    this.classList.remove('active');
                    content.classList.remove('active');
                } else {
                    this.classList.add('active');
                    content.classList.add('active');
                }
            });
        });

        // Auto-expand parent section if child page is active
        document.addEventListener('DOMContentLoaded', function() {
            const parentActiveHeader = document.querySelector('.mobile-accordion-header.parent-active');
            if (parentActiveHeader) {
                const section = parentActiveHeader.dataset.section;
                const content = document.getElementById(section + '-content');
                if (content) {
                    parentActiveHeader.classList.add('active');
                    content.classList.add('active');
                }
            }
        });

        // Authentication and user session management
        function loadUserInfo() {
            try {
                const authData = localStorage.getItem('lexai_auth');
                if (authData) {
                    const auth = JSON.parse(authData);
                    if (auth.user) {
                        const user = auth.user;
                        const firstName = user.first_name || 'Demo';
                        const lastName = user.last_name || 'User';
                        const email = user.email || 'demo@lexai.com';
                        
                        // Update user info in UI
                        document.getElementById('userName').textContent = `${firstName} ${lastName}`;
                        document.getElementById('userEmail').textContent = email;
                        document.getElementById('userInitials').textContent = 
                            `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase();
                    }
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // Comprehensive logout functionality
        window.handleLogout = async function() {
            try {
                // Call logout API
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                
                // Comprehensive cleanup of all stored data
                clearAllStoredData();
                
                // Redirect to login
                window.location.href = data.redirect || '/auth/login';
            } catch (error) {
                console.error('Logout error:', error);
                // Still clear all stored data and redirect
                clearAllStoredData();
                window.location.href = '/auth/login';
            }
        };

        // Function to clear all stored authentication and user data
        function clearAllStoredData() {
            // Clear localStorage items
            localStorage.removeItem('lexai_auth');
            localStorage.removeItem('lexai_onboarding');
            localStorage.removeItem('stripe_onboarding');
            localStorage.removeItem('lexai_timer_state');
            localStorage.removeItem('lexai_time_entries');
            
            // Set logout flag to prevent auto-login
            localStorage.setItem('lexai_logout_flag', Date.now().toString());
            
            // Clear any client-specific localStorage items
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('client_notes_') || 
                    key.startsWith('last_call_') || 
                    key.startsWith('last_email_')) {
                    localStorage.removeItem(key);
                }
            });
            
            // Clear sessionStorage completely
            sessionStorage.clear();
            
            // Force browser to not cache anything
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    names.forEach(function(name) {
                        caches.delete(name);
                    });
                });
            }
        }

        // Check authentication status
        function checkAuthStatus() {
            const authData = localStorage.getItem('lexai_auth');
            const currentPath = window.location.pathname;
            const logoutFlag = localStorage.getItem('lexai_logout_flag');
            
            // If user just logged out, don't auto-create demo session
            if (logoutFlag) {
                const logoutTime = parseInt(logoutFlag);
                const now = Date.now();
                // Prevent auto-login for 5 seconds after logout
                if (now - logoutTime < 5000) {
                    return false;
                }
                // Remove old logout flag
                localStorage.removeItem('lexai_logout_flag');
            }
            
            // DEVELOPMENT MODE: Skip authentication check for now
            // TODO: Re-enable authentication checks in production
            /*
            if (!authData && !currentPath.startsWith('/auth/') && currentPath !== '/') {
                window.location.href = '/auth/login';
                return false;
            }
            */
            
            // If no auth data and we're not on landing/login pages, create demo session for development
            if (!authData && !currentPath.includes('/auth/') && currentPath !== '/') {
                const demoAuth = {
                    user: {
                        first_name: 'Demo',
                        last_name: 'User',
                        email: 'demo@lexai.com',
                        firm_name: 'Demo Law Firm',
                        role: 'Legal Professional'
                    },
                    loginTime: new Date().toISOString()
                };
                localStorage.setItem('lexai_auth', JSON.stringify(demoAuth));
            }
            
            return true;
        }

        // Load user functionality
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            checkAuthStatus();
        });

        // User dropdown functionality
        document.getElementById('userMenuButton').addEventListener('click', function(e) {
            e.stopPropagation();
            const dropdown = document.querySelector('.base-user-dropdown');
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        });

        // Close user dropdown when clicking outside
        document.addEventListener('click', function() {
            const dropdown = document.querySelector('.base-user-dropdown');
            dropdown.style.display = 'none';
        });

        // ====== SESSION TIMEOUT WARNING SYSTEM ======
        let sessionTimeoutWarning = null;
        let sessionTimeoutInterval = null;
        let lastActivityTime = Date.now();
        const SESSION_TIMEOUT = 3600000; // 1 hour in milliseconds
        const WARNING_TIME = 300000; // 5 minutes before timeout

        // Track user activity
        function updateActivity() {
            lastActivityTime = Date.now();
            
            // If warning is showing and user is active, hide it
            if (sessionTimeoutWarning) {
                hideSessionWarning();
            }
        }

        // Add activity listeners
        ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
            document.addEventListener(event, updateActivity, true);
        });

        // Check session timeout periodically
        function checkSessionTimeout() {
            const timeSinceActivity = Date.now() - lastActivityTime;
            const timeUntilTimeout = SESSION_TIMEOUT - timeSinceActivity;
            
            // Show warning if 5 minutes left
            if (timeUntilTimeout <= WARNING_TIME && timeUntilTimeout > 0 && !sessionTimeoutWarning) {
                showSessionWarning(Math.floor(timeUntilTimeout / 60000)); // minutes left
            }
            
            // Force logout if session expired
            if (timeUntilTimeout <= 0) {
                forceLogout();
            }
        }

        // Show session timeout warning
        function showSessionWarning(minutesLeft) {
            if (sessionTimeoutWarning) return; // Already showing
            
            // Create warning modal
            sessionTimeoutWarning = document.createElement('div');
            sessionTimeoutWarning.id = 'sessionTimeoutWarning';
            sessionTimeoutWarning.innerHTML = `
                <div style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">
                    <div style="
                        background: white;
                        border-radius: 0.75rem;
                        padding: 2rem;
                        max-width: 400px;
                        width: 90%;
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                        text-align: center;
                    ">
                        <div style="
                            width: 4rem;
                            height: 4rem;
                            background: #FFA74F;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 0 auto 1rem;
                            font-size: 1.5rem;
                        ">‚ö†Ô∏è</div>
                        <h3 style="
                            color: #2E4B3C;
                            font-size: 1.25rem;
                            font-weight: 600;
                            margin: 0 0 0.5rem 0;
                        ">Session Timeout Warning</h3>
                        <p style="
                            color: #6b7280;
                            margin: 0 0 1.5rem 0;
                            line-height: 1.5;
                        ">Your session will expire in <strong id="timeoutCountdown">${minutesLeft}</strong> minute(s) due to inactivity. You'll be automatically logged out to protect your data.</p>
                        <div style="
                            display: flex;
                            gap: 0.75rem;
                            justify-content: center;
                        ">
                            <button onclick="extendSession()" style="
                                background: #2E4B3C;
                                color: #F7EDDA;
                                border: none;
                                padding: 0.75rem 1.5rem;
                                border-radius: 0.5rem;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            ">Stay Logged In</button>
                            <button onclick="logoutNow()" style="
                                background: transparent;
                                color: #6b7280;
                                border: 1px solid #d1d5db;
                                padding: 0.75rem 1.5rem;
                                border-radius: 0.5rem;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            ">Logout Now</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(sessionTimeoutWarning);
            
            // Update countdown every second
            const countdownElement = document.getElementById('timeoutCountdown');
            const countdownInterval = setInterval(() => {
                const timeSinceActivity = Date.now() - lastActivityTime;
                const timeUntilTimeout = SESSION_TIMEOUT - timeSinceActivity;
                const minutesLeft = Math.floor(timeUntilTimeout / 60000);
                
                if (minutesLeft <= 0) {
                    clearInterval(countdownInterval);
                    forceLogout();
                } else {
                    countdownElement.textContent = minutesLeft;
                }
            }, 1000);
            
            // Store interval to clear later
            sessionTimeoutWarning.countdownInterval = countdownInterval;
        }

        // Hide session warning
        function hideSessionWarning() {
            if (sessionTimeoutWarning) {
                if (sessionTimeoutWarning.countdownInterval) {
                    clearInterval(sessionTimeoutWarning.countdownInterval);
                }
                sessionTimeoutWarning.remove();
                sessionTimeoutWarning = null;
            }
        }

        // Extend session (user clicked "Stay Logged In")
        window.extendSession = function() {
            updateActivity(); // Reset activity timer
            hideSessionWarning();
            
            // Optional: Make API call to extend server session
            fetch('/api/auth/extend-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).catch(error => {
                console.log('Session extension failed:', error);
                // Continue anyway - client-side timeout still reset
            });
        };

        // Logout immediately (user clicked "Logout Now")
        window.logoutNow = function() {
            hideSessionWarning();
            logoutUser();
        };

        // Force logout due to timeout
        function forceLogout() {
            hideSessionWarning();
            clearAllStoredData();
            
            // Show timeout message
            alert('Your session has expired due to inactivity. You will be redirected to the login page.');
            
            // Redirect to login with timeout parameter
            window.location.href = '/login?reason=timeout';
        }

        // Start session monitoring (only if user is logged in)
        function startSessionMonitoring() {
            const authData = localStorage.getItem('lexai_auth');
            if (authData && !sessionTimeoutInterval) {
                sessionTimeoutInterval = setInterval(checkSessionTimeout, 30000); // Check every 30 seconds
            }
        }

        // Stop session monitoring
        function stopSessionMonitoring() {
            if (sessionTimeoutInterval) {
                clearInterval(sessionTimeoutInterval);
                sessionTimeoutInterval = null;
            }
            hideSessionWarning();
        }

        // Initialize session monitoring on page load
        document.addEventListener('DOMContentLoaded', function() {
            startSessionMonitoring();
        });

        // Stop monitoring when page unloads
        window.addEventListener('beforeunload', function() {
            stopSessionMonitoring();
        });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>